20180809_테스트 주도 개발

- 수업목표

refactoring  동작을 유지하는 게 중요하다. 유지보수 하면서 좀 더 읽기 편하게 하기 위해. 

애자일 방법론은 프랙탈 처럼 생겼다. 전체 프로그램 안에 릴리즈/ 이터레이션/하루하루가 반복된다. 스케일이 반복되는데, 가장 작은 단위는 테스트 주도 개발이다. 사이클을 돌면서 개발하는 것이다. 

- 가상환경만들기.

1. 슬랙봇 프로젝트를 포크한다.
2. 로컬로 클론받는다. 
3. 슬랙봇 디렉토리 안으로 들어가서 가상환경을 만든다. (pipenv 이용)
4. slack _token에는 secret으로 숨김.  
5. 

- 테스트주도 개발

슬랙을 킬 때마다 저장-중단-재실행-슬랙켜서 확인 . 하나의 테스트 사이클을 도는 것인데 이는 매우 번거롭다. 이를 거치지 않기 위해서 담긴 로직과 슬랙 통신 부분을 분리할 것이다. 어떤 대답을 할 것인지에 대한 로직만 따로 떼어서 테스트를 해볼 수 있다. 

1. text가 중복되어 있는데 이를 분리해낼 것이다. 

2. 읽어내는 부분과 답을 보내는 부분이 두개가 있다. 항상 특정채널에 보내기 때문에 바뀌는 부분은 reply만이다. 

3. def 변수 안에서 reply변수는 하나만 있어도된다. 

4. reply는 계속 존재한다. 

   ```
           if "날씨" in text:
               reply = "기상인데요?"
           elif "기상인데요?" == "text":
               die = str(random.randint(1, 6))
           else:
               reply = None
               
      # 여기는 슬랙이랑 관련이 없다. 이 로직은 따로 떼어낼 수 있다. 
   ```

\# 함수는 짧으면 짧을수록 좋다. 

\# None type을 얘기할 때는 ==형식을 안쓰고 is not을 쓴다. 

5. 하나의 가치를 만들어냈으면 GIT PUSH를 하는 것이 좋다. 

   GIT ignore file을 생성해서 토큰 , 비밀번호 등은 올라가지 않게 만들수 있다. 

   

6. 로직을 떼어내서 새로운 파일로 만든다. 이렇게 하면 슬랙을 킬 필요가 없다. 

   ```
   def answer(text):
       if "날씨니?" in text:
           reply = "기상인데요?"
       elif "기상인데요?" == "text":
           die = str(random.randint(1, 6))
       else:
           reply = None
       return reply
   # 파일을 따로 만들고 이를 main에서 import한다. 
   ```

main.py의 의존 파일을 그려볼 수 있다. dependency graph로 그려본다면 main.py를 중심으로 의존하는 파일 여러개를 그릴 수 있고, 그 각각의 파일들은 독립적으로 실행될 수 있다. 

7. pytest를 설치한다. unit test를 가능하게 해준다. 프로그램의 부분부분을 테스트해볼 수 있게 해준다. 
8. tests.py :  method file이다.

```
def test_plus():
    assert 1 + 2 == 4
# 1+2는 4여야한다고 단언하는 것.
# 아나콘다로 돌려보면 실패한다. 이에 대한 장황한 설명이 나온다. 
# 고치고 다시 해보면 성공하는데, .은 테스트 유닛하나를 돌렸다는 뜻이다.
```

9. 실제로 chat logic 을 실험해보자. 

```

def test_plus():
    expected = "불렀어?"
    actual = answer("애란")
    assert expected == actual
```

```
def test_roll_a_die():
    expected = {"1", "2", "3", "4", "5", "6"} # 집합 ; set
    actual = {answer("주사위") for _ in range(1000)}
    # for _ in range(1000): 
    # _는 파이썬에서 합법적인 문법인데, 이것은 파이썬 개발자들 사이\에서 안쓰인다는 말을 뜻한다. i로 쓰기에는 안쓰는 변수일 때. 
    #     actual.add(answer("주사위"))
    assert expected == actual
   
```

test 개발은 우리가 틀렸는지 안틀렸는지에 대해서 빠르게 피드백을 받을 수 있다. 코드가 틀렸을 때도 두려움에 떨지않고 바꿔볼 수 있다. test case가 잘 갖춰져있으면 자신감을 가지고 수정해볼 수 있다. 

테스트에 의해서 개발이 drive된다는 것은 test를 먼저짜고 코드를 짠다. 

```
# 테스트 주도 개발 방법

1. 테스트를 추가한다.
2. 테스트를 실행하여 테스트 실패를 확인한다.
3. 코드를 고쳐서 최대한 빨리 테스트를 성공시킨다.
4. 코드를 깔끔하게 다듬는다. (refactoring)
깔끔한 코드(clean code)란?
- 의도가 잘 드러난다
- 중복이 없다
좋은 코드란? Clean code that works
두가지가 만족되는게 좋은 코드이다. 두개를 한번에 하기는 어려우니 works를 먼저만들고 그다음 clean코드를 만든다. 
테스트를 다시 실행하여 여전히 성공하는지 확인한다.
GOTO 1

```

라이브러리의 형태는 패키지 형태로 배포된다. 패키지 안에 뭐가 들었느냐도 그때그때 다르다. 패키지 안에는 하나의 모듈만 들어있을 수 있다. 

가장 간단 라이브러리는 패키지 -모듈 - 함수하나. 빈 패키지도 만들 수 있다. 

 내가 개발하는 봇은 내이름을 붙이고, 내이름에만 응답하게 만든다. 

test 주도 개발에서는 프롬프트가 나에게 말을 한다고 생각하면된다. 

